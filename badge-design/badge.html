<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="badge.css">
    <title>BADGE DESIGN</title>
</head>
<body>

    <div id="content">
        <div id="control-panel">

        </div>
        <div id="main-content">
            <div id="svg-handler-container">
                <div class="svg-container">
                    <svg id="artboard" viewBox="0 0 400 400">
                        <svg class="element" viewBox="0 0 300 300" x="100" y="100" width="100" height="100">
                            <circle cx="150" cy="150" r="150" fill="red" />
                        </svg>
                    </svg>
                </div>
                <div id="handler" style="display: none;">
                    <div id="handle-tl"></div>
                    <div id="handle-tr"></div>
                    <div id="handle-br"></div>
                    <div id="handle-bl"></div>
                    <div id="handle-ct"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const artboard = document.querySelector("svg#artboard");
        const elements = artboard.querySelectorAll(".element");
        const handler = document.querySelector("#handler");
        attachEventOnHandle();
        artboard.addEventListener('click', function(event) {
            if(!isDragging && event.currentTarget == event.target){
                selectedElement = null;
                handler.style.display = "none";
            }
        })
        var selectedElement = null;
        var offset = null;
        var isDragging = false;
        for(const element of elements){
            element.addEventListener("mousedown", dragStart);
            element.addEventListener("mouseup", dragEnd);
        }

        function attachEventOnHandle(){
            var handleTL = document.querySelector("#handle-tl");
            var handleTR = document.querySelector("#handle-tr");
            var handleBR = document.querySelector("#handle-br");
            var handleBL = document.querySelector("#handle-bl");

            handleTL.addEventListener('mousedown', function(event) { document.addEventListener('mouseup', function(event) {   artboard.removeEventListener('mousemove', scaleTL);}); artboard.addEventListener('mousemove', scaleTL);})
            handleTR.addEventListener('mousedown', function(event) { document.addEventListener('mouseup', function(event) {   artboard.removeEventListener('mousemove', scaleTR);}); artboard.addEventListener('mousemove', scaleTR);})
            handleBR.addEventListener('mousedown', function(event) { document.addEventListener('mouseup', function(event) {   artboard.removeEventListener('mousemove', scaleBR);}); artboard.addEventListener('mousemove', scaleBR);})
            handleBL.addEventListener('mousedown', function(event) { document.addEventListener('mouseup', function(event) {   artboard.removeEventListener('mousemove', scaleBL);}); artboard.addEventListener('mousemove', scaleBL);})
        }

        function dragStart(event) {
            event.preventDefault();
            event.stopPropagation();
            console.log("DRAGSTART");
            isDragging = true;
            const target = event.currentTarget;
            selectedElement = target;
            var x = target.getAttribute('x');
            x = x ? parseFloat(x) : 0;
            var y = target.getAttribute('y');
            y = y ? parseFloat(y) : 0;
            offset = getMousePosition(event);
            offset.x -= x;
            offset.y -= y;
            document.addEventListener("mouseup", dragEnd);
            document.addEventListener("mousemove", drag);
            putHandler();
        }
        
        function dragEnd(event) {
            if(isDragging){
                event.preventDefault();
                event.stopPropagation();
                isDragging = false;
                document.removeEventListener("mouseup", dragEnd);
                document.removeEventListener("mousemove", drag);
                console.log("DRAGEND");
            }
        }
        function drag(event){
            if(isDragging){
                event.preventDefault();
                event.stopPropagation();
                const target = selectedElement;
                var coord = getMousePosition(event);
                target.setAttributeNS(null, 'x', coord.x - offset.x);
                target.setAttributeNS(null, 'y', coord.y - offset.y);
                putHandler();
            }
        }
        function getMousePosition(evt) {
            var CTM = artboard.getScreenCTM();
            return {
              x: (evt.clientX - CTM.e) / CTM.a,
              y: (evt.clientY - CTM.f) / CTM.d
            };
        }

        function getRectOfSelectedElement(){
            var x = selectedElement.getAttribute('x');
            var y = selectedElement.getAttribute('y');
            var width = selectedElement.getAttribute('width');
            width = width ? parseFloat(width) : 0;
            var height = selectedElement.getAttribute('height');
            height = height ? parseFloat(height) : 0;
            return {x,y,width, height};
        }

        function putHandler(){
            if(selectedElement){
                var {x,y,width, height} = getRectOfSelectedElement();
                handler.style.left = x + "px";
                handler.style.top = y + "px";
                handler.style.width = width + "px";
                handler.style.height = height + "px";
                handler.style.display = "block";
            }
        }
        function scaleBR(event){
            if(selectedElement){
                event.preventDefault();
                event.stopPropagation();
                var {x,y,width, height} = getRectOfSelectedElement();
                var positionMouse = getMousePosition(event);
                width = positionMouse.x - Number(x);
                height = positionMouse.y - Number(y);
                selectedElement.setAttribute('width',width);
                selectedElement.setAttribute('height',height);
                putHandler();
            }
        }
        function scaleTL(event){
            if(selectedElement){
                event.preventDefault();
                event.stopPropagation();
                var {x,y,width, height} = getRectOfSelectedElement();
                var oldX = x;
                var oldY = y;
                var positionMouse = getMousePosition(event);
                x = positionMouse.x;
                y = positionMouse.y;
                width += oldX - x;
                height += oldY - y;
                selectedElement.setAttribute('x',x);
                selectedElement.setAttribute('y',y);
                selectedElement.setAttribute('width',width);
                selectedElement.setAttribute('height',height);
                putHandler();
            }
        }
        function scaleTR(event){
            if(selectedElement){
                event.preventDefault();
                event.stopPropagation();
                var {x,y,width, height} = getRectOfSelectedElement();
                var oldY = y;
                var positionMouse = getMousePosition(event);
                y = positionMouse.y;
                width = positionMouse.x - Number(x);
                height += oldY - y;
                selectedElement.setAttribute('y',y);
                selectedElement.setAttribute('width',width);
                selectedElement.setAttribute('height',height);
                putHandler();
            }
        }
        function scaleBL(event){
            if(selectedElement){
                event.preventDefault();
                event.stopPropagation();
                var {x,y,width, height} = getRectOfSelectedElement();
                var oldX = x;
                var positionMouse = getMousePosition(event);
                x = positionMouse.x;
                height = positionMouse.y - Number(y);
                width += oldX - x;
                selectedElement.setAttribute('x',x);
                selectedElement.setAttribute('width',width);
                selectedElement.setAttribute('height',height);
                putHandler();
            }
        }
        function scaleCT(event){
            if(selectedElement){
                event.preventDefault();
                event.stopPropagation();
                putHandler();
            }
        }

    </script>
    
</body>
</html>