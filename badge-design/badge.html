<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="badge.css">
    <title>BADGE DESIGN</title>
</head>
<body>

    <div id="content">
        <div id="control-panel">
            <div id="element-container">

            </div>
        </div>
        <div id="main-content">
            <div id="svg-handler-container">
                <div class="svg-container">
                    <svg id="artboard" viewBox="0 0 400 400">
                        <svg class="element" viewBox="0 0 300 300" x="100" y="100" width="100" height="100">
                            <circle cx="150" cy="150" r="150" fill="red" />
                        </svg>
                        <svg class="element" viewBox="0 0 300 300" x="300" y="100" width="100" height="100">
                            <rect x="0" y="0" width="300" height="300" fill="green" />
                        </svg>
                    </svg>
                </div>
                <div id="handler" style="display: none;">
                    <div id="handle-tl"></div>
                    <div id="handle-tr"></div>
                    <div id="handle-br"></div>
                    <div id="handle-bl"></div>
                    <div id="handle-ct"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="index.js"></script>

    <script>
        const artboard = document.querySelector("svg#artboard");

        const stackControl = new StackControl();

    </script>

    <script>

        var components = [
            'circle1c.svg',
            'hex1.svg',
            'shield1.svg',
            'shield2.svg',
            'shield1.svg',
            'shield2.svg',
        ]

        var controlPanel = document.querySelector("#control-panel");
        var elementContainer = controlPanel.querySelector("#element-container");
        for(const component of components){
            fetch("./components/" + component).then((r)=>{
                r.text().then((d)=>{
                    const element = document.createElement("div");
                    element.setAttribute("class", "element");
                    element.innerHTML = d
                    elementContainer.appendChild(element);
                    element.addEventListener("click", function (event) {
                        const svg = element.querySelector("svg").cloneNode(true);
                        svg.setAttribute("class", "element");
                        artboard.appendChild(svg);
                        attachEventOnElements();
                    });
                })
            })
        }

    </script>

    <script>
        var offset = null;
        var isDragging = false;
        var startDragPoint = null;
        

        attachEventOnElements();
        attachEventOnHandle();
        attachKeyboardEvents();

        artboard.addEventListener('click', function(event) {
            if(!isDragging && event.currentTarget == event.target){
                CurrentElement.selectedElement = null;
                Handler.hide();
            }
        })
        

        function attachKeyboardEvents(){
            document.addEventListener('keyup', function(event){
                if(CurrentElement.selectedElement){
                    if(event.which == 46){
                        remove();
                    }
                }
            });
        }
        
        function attachEventOnElements(){
            const elements = artboard.querySelectorAll("svg.element");
            for(const element of elements){
                attachEventOnElement(element);
            }
        }

        function attachEventOnElement(element){
            element.removeEventListener("mousedown", dragStart);
            element.removeEventListener("mouseup", dragEnd);
            element.addEventListener("mousedown", dragStart);
            element.addEventListener("mouseup", dragEnd);
        }

        function attachEventOnHandle(){
            var handleTL = document.querySelector("#handle-tl");
            var handleTR = document.querySelector("#handle-tr");
            var handleBR = document.querySelector("#handle-br");
            var handleBL = document.querySelector("#handle-bl");

            handleTL.addEventListener('mousedown', function(event) { document.addEventListener('mouseup', function(event) {   artboard.removeEventListener('mousemove', scaleTL);}); artboard.addEventListener('mousemove', scaleTL);})
            handleTR.addEventListener('mousedown', function(event) { document.addEventListener('mouseup', function(event) {   artboard.removeEventListener('mousemove', scaleTR);}); artboard.addEventListener('mousemove', scaleTR);})
            handleBR.addEventListener('mousedown', function(event) { document.addEventListener('mouseup', function(event) {   artboard.removeEventListener('mousemove', scaleBR);}); artboard.addEventListener('mousemove', scaleBR);})
            handleBL.addEventListener('mousedown', function(event) { document.addEventListener('mouseup', function(event) {   artboard.removeEventListener('mousemove', scaleBL);}); artboard.addEventListener('mousemove', scaleBL);})
        }

        function dragStart(event) {
            event.preventDefault();
            event.stopPropagation();
            const target = event.currentTarget;
            CurrentElement.selectedElement = target;
            var x = target.getAttribute('x');
            x = x ? parseFloat(x) : 0;
            var y = target.getAttribute('y');
            y = y ? parseFloat(y) : 0;

            startDragPoint = new Point(x,y);

            offset = getMousePosition(event);
            offset.x -= x;
            offset.y -= y;
            document.addEventListener("mouseup", dragEnd);
            document.addEventListener("mousemove", drag);
            Handler.dispatchHandler(CurrentElement.selectedElement);
        }
        
        function dragEnd(event) {
            event.preventDefault();
            event.stopPropagation();
            document.removeEventListener("mouseup", dragEnd);
            document.removeEventListener("mousemove", drag);
            if(isDragging){
                isDragging = false;
                const {x,y} = SvgUtils.getRectOfElement(CurrentElement.selectedElement).toObject();
                stackControl.do(new DragCommand(CurrentElement.selectedElement, startDragPoint, new Point(x,y)));
                console.log("DRAGEND");
            }
        }
        function drag(event){
            if(!isDragging){
                console.log("DRAGSTART");
                isDragging = true;
            }
            if(isDragging){
                event.preventDefault();
                event.stopPropagation();
                var coord = getMousePosition(event);
                SvgUtils.setPoint(CurrentElement.selectedElement, new Point(coord.x - offset.x, coord.y - offset.y));
            }
        }
        function getMousePosition(evt) {
            var CTM = artboard.getScreenCTM();
            return {
              x: (evt.clientX - CTM.e) / CTM.a,
              y: (evt.clientY - CTM.f) / CTM.d
            };
        }

        function scaleBR(event){
            if(CurrentElement.selectedElement){
                event.preventDefault();
                event.stopPropagation();
                var {x,y,width, height} = SvgUtils.getRectOfElement(CurrentElement.selectedElement).toObject();
                var positionMouse = getMousePosition(event);
                width = positionMouse.x - Number(x);
                height = positionMouse.y - Number(y);
                CurrentElement.selectedElement.setAttribute('width',width);
                CurrentElement.selectedElement.setAttribute('height',height);
                ;
            }
        }
        function scaleTL(event){
            if(CurrentElement.selectedElement){
                event.preventDefault();
                event.stopPropagation();
                var {x,y,width, height} = SvgUtils.getRectOfElement(CurrentElement.selectedElement).toObject();
                var oldX = x;
                var oldY = y;
                var positionMouse = getMousePosition(event);
                x = positionMouse.x;
                y = positionMouse.y;
                width += oldX - x;
                height += oldY - y;
                CurrentElement.selectedElement.setAttribute('x',x);
                CurrentElement.selectedElement.setAttribute('y',y);
                CurrentElement.selectedElement.setAttribute('width',width);
                CurrentElement.selectedElement.setAttribute('height',height);
                
            }
        }
        function scaleTR(event){
            if(CurrentElement.selectedElement){
                event.preventDefault();
                event.stopPropagation();
                var {x,y,width, height} = SvgUtils.getRectOfElement(CurrentElement.selectedElement).toObject();
                var oldY = y;
                var positionMouse = getMousePosition(event);
                y = positionMouse.y;
                width = positionMouse.x - Number(x);
                height += oldY - y;
                CurrentElement.selectedElement.setAttribute('y',y);
                CurrentElement.selectedElement.setAttribute('width',width);
                CurrentElement.selectedElement.setAttribute('height',height);
                
            }
        }
        function scaleBL(event){
            if(CurrentElement.selectedElement){
                event.preventDefault();
                event.stopPropagation();
                var {x,y,width, height} = SvgUtils.getRectOfElement(CurrentElement.selectedElement).toObject();
                var oldX = x;
                var positionMouse = getMousePosition(event);
                x = positionMouse.x;
                height = positionMouse.y - Number(y);
                width += oldX - x;
                CurrentElement.selectedElement.setAttribute('x',x);
                CurrentElement.selectedElement.setAttribute('width',width);
                CurrentElement.selectedElement.setAttribute('height',height);
                
            }
        }
        function scaleCT(event){
            if(CurrentElement.selectedElement){
                event.preventDefault();
                event.stopPropagation();
                
            }
        }

        function putDown(){
            if(CurrentElement.selectedElement){
                if(isActiveDown()){
                    var index = Array.from(artboard.children).indexOf(CurrentElement.selectedElement);
                    artboard.insertBefore(artboard.children[index], artboard.children[index - 1])
                }
            }
        }
        function putUp(){
            if(CurrentElement.selectedElement){
                if(isActiveUp()){
                    var index = Array.from(artboard.children).indexOf(CurrentElement.selectedElement);
                    artboard.insertBefore(artboard.children[index + 1], artboard.children[index])
                }
            }
        }

        function isActiveUp(){
            if(CurrentElement.selectedElement){
                var index = Array.from(artboard.children).indexOf(CurrentElement.selectedElement);
                return index + 1 < artboard.childElementCount;
            }
        }

        function isActiveDown(){
            if(CurrentElement.selectedElement){
                var index = Array.from(artboard.children).indexOf(CurrentElement.selectedElement);
                return index > 0 && index < artboard.childElementCount;
            }
        }

        function remove(){
            if(CurrentElement.selectedElement){
                artboard.removeChild(CurrentElement.selectedElement);
                Handler.hide();
            }
        }

        function duplicate(){
            if(CurrentElement.selectedElement){
                stackControl.do(new DuplicateCommand(CurrentElement.selectedElement, artboard));
            }
        }

        function undo(){
            stackControl.back();
        }
        function redo(){
            stackControl.forward();
        }

    </script>
    
</body>
</html>