<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="badge.css">
    <title>BADGE DESIGN</title>
</head>
<body>

    <div id="content">
        <div id="control-panel">
            <div id="element-container">

            </div>
        </div>
        <div id="main-content">
            <div id="svg-handler-container">
                <div class="svg-container">
                    <svg id="artboard" viewBox="0 0 400 400">
                        <svg class="element" viewBox="0 0 300 300" x="100" y="100" width="100" height="100">
                            <circle cx="150" cy="150" r="150" fill="red" />
                        </svg>
                        <svg class="element" viewBox="0 0 300 300" x="300" y="100" width="100" height="100">
                            <rect x="0" y="0" width="300" height="300" fill="green" />
                        </svg>
                    </svg>
                </div>
                <div id="handler" style="display: none;">
                    <div id="handle-tl"></div>
                    <div id="handle-tr"></div>
                    <div id="handle-br"></div>
                    <div id="handle-bl"></div>
                    <div id="handle-ct"></div>
                </div>
            </div>
        </div>
    </div>

    <script>

        var components = [
            'circle1c.svg',
            'hex1.svg',
            'shield1.svg',
            'shield2.svg',
            'shield1.svg',
            'shield2.svg',
        ]

        var controlPanel = document.querySelector("#control-panel");
        var elementContainer = controlPanel.querySelector("#element-container");
        for(const component of components){
            fetch("./components/" + component).then((r)=>{r.text().then((d)=>{
                const element = document.createElement("div");
                element.setAttribute("class", "element");
                element.innerHTML = d
                elementContainer.appendChild(element);
            })
            })
        }

    </script>

    <script>
        const artboard = document.querySelector("svg#artboard");
        const handler = document.querySelector("#handler");

        attachEventOnElements();
        attachEventOnHandle();

        artboard.addEventListener('click', function(event) {
            if(!isDragging && event.currentTarget == event.target){
                selectedElement = null;
                handler.style.display = "none";
            }
        })
        var selectedElement = null;
        var offset = null;
        var isDragging = false;
        
        function attachEventOnElements(){
            const elements = artboard.querySelectorAll("svg.element");
            for(const element of elements){
                attachEventOnElement(element);
            }
        }

        function attachEventOnElement(element){
            element.removeEventListener("mousedown", dragStart);
            element.removeEventListener("mouseup", dragEnd);
            element.addEventListener("mousedown", dragStart);
            element.addEventListener("mouseup", dragEnd);
        }

        function attachEventOnHandle(){
            var handleTL = document.querySelector("#handle-tl");
            var handleTR = document.querySelector("#handle-tr");
            var handleBR = document.querySelector("#handle-br");
            var handleBL = document.querySelector("#handle-bl");

            handleTL.addEventListener('mousedown', function(event) { document.addEventListener('mouseup', function(event) {   artboard.removeEventListener('mousemove', scaleTL);}); artboard.addEventListener('mousemove', scaleTL);})
            handleTR.addEventListener('mousedown', function(event) { document.addEventListener('mouseup', function(event) {   artboard.removeEventListener('mousemove', scaleTR);}); artboard.addEventListener('mousemove', scaleTR);})
            handleBR.addEventListener('mousedown', function(event) { document.addEventListener('mouseup', function(event) {   artboard.removeEventListener('mousemove', scaleBR);}); artboard.addEventListener('mousemove', scaleBR);})
            handleBL.addEventListener('mousedown', function(event) { document.addEventListener('mouseup', function(event) {   artboard.removeEventListener('mousemove', scaleBL);}); artboard.addEventListener('mousemove', scaleBL);})
        }

        function dragStart(event) {
            event.preventDefault();
            event.stopPropagation();
            console.log("DRAGSTART");
            isDragging = true;
            const target = event.currentTarget;
            selectedElement = target;
            var x = target.getAttribute('x');
            x = x ? parseFloat(x) : 0;
            var y = target.getAttribute('y');
            y = y ? parseFloat(y) : 0;
            offset = getMousePosition(event);
            offset.x -= x;
            offset.y -= y;
            document.addEventListener("mouseup", dragEnd);
            document.addEventListener("mousemove", drag);
            putHandler();
        }
        
        function dragEnd(event) {
            if(isDragging){
                event.preventDefault();
                event.stopPropagation();
                isDragging = false;
                document.removeEventListener("mouseup", dragEnd);
                document.removeEventListener("mousemove", drag);
                console.log("DRAGEND");
            }
        }
        function drag(event){
            if(isDragging){
                event.preventDefault();
                event.stopPropagation();
                const target = selectedElement;
                var coord = getMousePosition(event);
                target.setAttributeNS(null, 'x', coord.x - offset.x);
                target.setAttributeNS(null, 'y', coord.y - offset.y);
                putHandler();
            }
        }
        function getMousePosition(evt) {
            var CTM = artboard.getScreenCTM();
            return {
              x: (evt.clientX - CTM.e) / CTM.a,
              y: (evt.clientY - CTM.f) / CTM.d
            };
        }

        function getRectOfSelectedElement(){
            var x = selectedElement.getAttribute('x');
            x = x ? parseFloat(x) : 0;
            var y = selectedElement.getAttribute('y');
            y = y ? parseFloat(y) : 0;
            var width = selectedElement.getAttribute('width');
            width = width ? parseFloat(width) : 0;
            var height = selectedElement.getAttribute('height');
            height = height ? parseFloat(height) : 0;
            return {x,y,width, height};
        }

        function putHandler(){
            if(selectedElement){
                var {x,y,width, height} = getRectOfSelectedElement();
                handler.style.left = x + "px";
                handler.style.top = y + "px";
                handler.style.width = width + "px";
                handler.style.height = height + "px";
                handler.style.display = "block";
            }
        }
        function scaleBR(event){
            if(selectedElement){
                event.preventDefault();
                event.stopPropagation();
                var {x,y,width, height} = getRectOfSelectedElement();
                var positionMouse = getMousePosition(event);
                width = positionMouse.x - Number(x);
                height = positionMouse.y - Number(y);
                selectedElement.setAttribute('width',width);
                selectedElement.setAttribute('height',height);
                putHandler();
            }
        }
        function scaleTL(event){
            if(selectedElement){
                event.preventDefault();
                event.stopPropagation();
                var {x,y,width, height} = getRectOfSelectedElement();
                var oldX = x;
                var oldY = y;
                var positionMouse = getMousePosition(event);
                x = positionMouse.x;
                y = positionMouse.y;
                width += oldX - x;
                height += oldY - y;
                selectedElement.setAttribute('x',x);
                selectedElement.setAttribute('y',y);
                selectedElement.setAttribute('width',width);
                selectedElement.setAttribute('height',height);
                putHandler();
            }
        }
        function scaleTR(event){
            if(selectedElement){
                event.preventDefault();
                event.stopPropagation();
                var {x,y,width, height} = getRectOfSelectedElement();
                var oldY = y;
                var positionMouse = getMousePosition(event);
                y = positionMouse.y;
                width = positionMouse.x - Number(x);
                height += oldY - y;
                selectedElement.setAttribute('y',y);
                selectedElement.setAttribute('width',width);
                selectedElement.setAttribute('height',height);
                putHandler();
            }
        }
        function scaleBL(event){
            if(selectedElement){
                event.preventDefault();
                event.stopPropagation();
                var {x,y,width, height} = getRectOfSelectedElement();
                var oldX = x;
                var positionMouse = getMousePosition(event);
                x = positionMouse.x;
                height = positionMouse.y - Number(y);
                width += oldX - x;
                selectedElement.setAttribute('x',x);
                selectedElement.setAttribute('width',width);
                selectedElement.setAttribute('height',height);
                putHandler();
            }
        }
        function scaleCT(event){
            if(selectedElement){
                event.preventDefault();
                event.stopPropagation();
                putHandler();
            }
        }

        function putDown(){
            if(selectedElement){
                if(isActiveDown()){
                    var index = Array.from(artboard.children).indexOf(selectedElement);
                    artboard.insertBefore(artboard.children[index], artboard.children[index - 1])
                }
            }
        }
        function putUp(){
            if(selectedElement){
                if(isActiveUp()){
                    var index = Array.from(artboard.children).indexOf(selectedElement);
                    artboard.insertBefore(artboard.children[index + 1], artboard.children[index])
                }
            }
        }

        function isActiveUp(){
            if(selectedElement){
                var index = Array.from(artboard.children).indexOf(selectedElement);
                return index + 1 < artboard.childElementCount;
            }
        }

        function isActiveDown(){
            if(selectedElement){
                var index = Array.from(artboard.children).indexOf(selectedElement);
                return index > 0 && index < artboard.childElementCount;
            }
        }

        function remove(){
            if(selectedElement){
                artboard.removeChild(selectedElement);
                handler.style.display = "none";
            }
        }

        function duplicate(){
            if(selectedElement){
                var index = Array.from(artboard.children).indexOf(selectedElement);
                var newNode = selectedElement.cloneNode(true);
                if(index != artboard.childElementCount - 1){
                    artboard.insertBefore(newNode, artboard.children[index + 1]);
                }else{
                    artboard.appendChild(newNode);
                }
                selectedElement = newNode;
                var {x,y} = getRectOfSelectedElement();
                x += 10;
                y += 10;
                selectedElement.setAttribute('x', x);
                selectedElement.setAttribute('y', y);
                putHandler();
                attachEventOnElements();
            }
        }

    </script>
    
</body>
</html>